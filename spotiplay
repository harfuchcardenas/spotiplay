#!/usr/bin/perl

use strict;  # Enforce strict variable declaration
use warnings; # Enable warnings for better debugging

# Print "Hello, World!" to the console
my $temp = '/../include';
my $current_directory = qx(pwd);
# Remove the newline character from the end of the output
chomp($current_directory);
$current_directory=$current_directory.$temp;

# Print the current directory path
print "Current directory: $current_directory\n";
# Specify the spotify_songs of your csv document with the list of songs currently been your favorites' songs on Spotify
my $spotify_songs = $current_directory.'/My Spotify Library.csv';
my @TSRC_csv;
my $TSRC_csv;
my @TSRC_mp3;
my $TSRC_mp3;
my @spotifyID;
my $spotifyID;
my $i = 0;

# Open the file for reading
open(my $fh, '<', $spotify_songs) or die "Could not open file '$spotify_songs' $!";
# Read the file line by line
while (my $line = <$fh>) {
    chomp($line);  # Remove the newline character at the end of the line
    # Split the line based on the specified character (comma in this case)
    my @strings = split(/,/, $line);
    # Print the separated strings
    $TSRC_csv[$i] = $strings[5];
    $spotifyID[$i] = $strings[6];
    $i++;
}
shift(@TSRC_csv);
shift(@spotifyID);
print "TSRCs: @TSRC_csv\nPress enter to continue"; #TSRC from CSV file from Spotify
<STDIN>;
print "SpotifyIDs: @spotifyID\nPress enter to continue"; #TSRC from CSV file from Spotify
<STDIN>;

# Close the file handle
close($fh);
system(`cd /media/aharfuch/E93B-943D/Musik`);
my @local_music= `ls ./`;
my $size_local_music = scalar @local_music;
my @spotifyURL;
my @args;
my @fallen;

$args[0]='ffmpeg -y -i ';
$args[1]=' -f ffmetadata metadata.txt -hide_banner';
my $apos = '"';

if($size_local_music == 0) {
    print "This folder has no titles from the playlist,
all titles will be downloaded.";
    foreach (@TSRC_csv){
        my $hash =$_;
        $hash =~ tr/"//d; #Remove double quotes
        if(!system("spotdl https://open.spotify.com/track/$hash")){
            next;
        }else{
            print "It has fallen, therefore pushing to fallen.\n";
            push(@fallen,$hash);
            }
        }
    exit 0;
} else {
    foreach my $line (@local_music) {
        chomp($line);
        print "Gefundene Datei: $line\n";
        my $ffmpeg_command =  $args[0].$apos.$line. $apos.$args[1];
        # Capture the output of the ffmpeg command
        print "FFMPEG: $ffmpeg_command\n";
        system($ffmpeg_command);
        my $file = 'metadata.txt';
        my $search_string = 'TSRC=';
        open(my $fh2, '<', $file) or die "Cannot open file.";
        while (my $line = <$fh2>) {
            if ($line =~ /\b\Q$search_string\E\b\s*(.+)/) {
                push @TSRC_mp3, $1;
                next;
            }
        }
    }

    my %seen = map { $_ => 1 } @TSRC_mp3;
    my @TSRC_download;

    for my $i (0 .. $#TSRC_csv) {
        unless ($seen{$TSRC_csv[$i]}) {
            push @TSRC_download, $TSRC_csv[$i];
        }
    }

    my @toDownload;
    for my $i (0 .. $#TSRC_csv) {
        if ($TSRC_download[$i] eq $TSRC_csv[$i]) {
            $toDownload[$i] = $spotifyID[$i];
        }
    }
    print "Size of \@toDownload: $#toDownload\n";
    print "Size of \@TSRC_cvs: $#TSRC_csv\n";
    <STDIN>;
    foreach (@toDownload){
        print "To get downloaded hash: $_.\n";
        my $hash =$_;
        $hash =~ tr/"//d;
        if(!system("spotdl https://open.spotify.com/track/$hash")){
        }
    }
}
